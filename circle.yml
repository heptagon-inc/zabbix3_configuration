machine:
  timezone: Asia/Tokyo
  environment:
    AWS_DEFAULT_REGION: ap-northeast-1
    #VAGRANT_VERSION: 1.8.1
    #VAGRANT_DEFAULT_PROVIDER: aws
  ruby:
    version: 2.2.3
  services:
    - docker

dependencies:
  pre:
    - |
      #wget https://releases.hashicorp.com/vagrant/${VAGRANT_VERSION}/vagrant_${VAGRANT_VERSION}_x86_64.deb
      #sudo dpkg --install vagrant_${VAGRANT_VERSION}_x86_64.deb
      #vagrant plugin install vagrant-aws vagrant-itamae
      #vagrant box add dummy https://github.com/mitchellh/vagrant-aws/raw/master/dummy.box


test:
  override:
    - |
      docker build -t local/amzn .
      docker run -it --privileged -w /home/ubuntu/zabbix3_configuration -v /home/ubuntu/zabbix3_configuration:/home/ubuntu/zabbix3_configuration:rw -e ITAMAE_SECRET_PASS=${ITAMAE_SECRET_PASS} local/amzn bash -c "bundle && bundle exec itamae local -y properties/zabbix3-web.yaml bootstrap.rb"
      #bundle exec itamae docker --image=youyo/amzn:2016.03 --node-yaml=properties/zabbix3-web.yaml bootstrap.rb
      #bundle exec itamae ssh -u ec2-user -i ${AWS_KEYPAIR_PATH} -p 22 -h zbx.heptagon.co.jp -y properties/zabbix3-web.yaml bootstrap.rb --dry-run && vagrant up
      #post:
      #- |
      #vagrant destroy -f

deployment:
  production:
    branch: release
    commands:
      - |
        bundle exec itamae ssh -u ec2-user -i ${AWS_KEYPAIR_PATH} -p 22 -h zbx.heptagon.co.jp -y properties/zabbix3-web.yaml bootstrap.rb
